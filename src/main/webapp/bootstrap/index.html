<!DOCTYPE html>
<html>
<head>
  <title>Bootstrap Karma Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
  <meta charset="UTF-8">
  <style type="text/css">
    body {
      padding-top: 10px;
    }

    .button-row {
      padding: 4px;
    }

    .btn-admin-op {
      text-transform:uppercase;
/*      font-variant:small-caps;
      text-transform:capitalize;*/
    }

    .button-header {
      text-transform:uppercase;
    }

    .panel-dark-gray {
      border-color: #6E6E6E;
    }

    .panel-dark-gray > .panel-heading {
      color:#fff;
      background-color: #6E6E6E;
      border-color: #6E6E6E;
    }

  </style>
</head>
<body>
  <script src="//code.jquery.com/jquery.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
  <script src="/js/initappid.js"></script>
  <script type="text/javascript">
    // This is boilerplate code that is used to initialize the Facebook
    // JS SDK.
    window.fbAsyncInit = function() {
      FB.init({
        appId : fbAppId, // App ID
        status : true, // check login status
        cookie : true, // enable cookies to allow the server to access the session
        xfbml : true
      // parse page for xfbml or html5 social plugins like login button below
      });

      // Put additional init code here

      FB.getLoginStatus(function(response) {
        onStatus(response); // once on page load
        FB.Event.subscribe('auth.statusChange', onStatus); // every status change
      });
    };

    // Load the SDK Asynchronously
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {
        return;
      }
      js = d.createElement(s);
      js.id = id;
      js.src = "//connect.facebook.net/en_US/all.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    function showBootstrapCurrentUserButton(response) {
      var uid = response.authResponse.userID;
      var token = response.authResponse.accessToken;
      var url = '/bootstrap/provider/fb/register?' + "uid=" + uid + "&" + "token=" + token;
      var button = '<button onclick="consoleLoggedRequest(' + url + ')"' + 
        ' type="submit" class="btn btn-block btn-default btn-admin-op">Bootstrap current user</button>';
      document.getElementById('account-info').innerHTML = (button);
    }

    function showLoginButton() {
      document.getElementById('account-info').innerHTML = ('<button class="btn btn-block btn-primary btn-admin-op" onclick="FB.login()">Login and connect via facebook</button>');
    }

    /**
     * This will be called once on page load, and every time the status changes.
     */
    function onStatus(response) {
      // Log.info('onStatus', response);
      if (response.status === 'connected') {
        showBootstrapCurrentUserButton(response);
      } else {
        showLoginButton();
      }
    }

    function consoleLoggedRequest(url) {
      var consoleOutput = '#consoleOutput'; 
      $(consoleOutput).val('Issuing request url="' + url + '"...');
      $.ajax({
        type: "GET",
        url: url,
        success: function(response) {
          $(consoleOutput).val(response);
        },
        error: function(xhr, status, error) {
          // TODO(avaliani): look into rendering html results in a responsive iframe.
          $(consoleOutput).val(
            "Operation failed:\n" +
            url + "\n" +
            "\n" +
            xhr.responseText);
        }        
      });
    }
  </script>

  <div class="container">
    <div class="row">
      <div class="col-md-12 panel panel-default">
        <div class="row text-center panel-heading">
          <span class="button-header">Karma Exchange Admin Console</span>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-5">
              <div class="row button-row">
                <div id="account-info"></div>
              </div>

              <div class="row button-row">          
                <button onclick="consoleLoggedRequest('/bootstrap/test_resources')" class="btn btn-block btn-primary btn-admin-op">Bootstrap test resources</button>
              </div>

              <div class="row button-row">          
                <button onclick="consoleLoggedRequest('/bootstrap/datastore_indexes')" class="btn btn-block btn-default btn-admin-op">Update datastore-indexes-auto.xml</button>
              </div>

              <div class="row button-row">          
                <button onclick="consoleLoggedRequest('/task/process_event_completions')" class="btn btn-block btn-default btn-admin-op">Process newly completed events</button>
              </div>

              <div class="row button-row">          
                <button onclick="consoleLoggedRequest('/task/compute_leaderboard')" class="btn btn-block btn-default btn-admin-op">Compute organization leaderboards</button>
              </div>

              <div class="row button-row">
                <button onclick="consoleLoggedRequest('/bootstrap/purge_resources')" class="btn btn-block btn-danger btn-admin-op">Delete all resources</button>
              </div>
            </div>
            <div class="col-md-7">
              <form role="form">
                <div class="form-group">                  
                  <textarea class="form-control" id="consoleOutput" rows=12 disabled></textarea>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--  Using this as a way to refresh the fb access token. Need to verify it works! -->
    <fb:facepile></fb:facepile>

  </div>

  <div id="fb-root"></div>

</body>
</html>
